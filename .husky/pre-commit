#!/usr/bin/env sh

# 색상 정의
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# lint-staged 실행 (staged 파일만 검사)
echo "${BLUE}🔍 Staged 파일 검사 중...${NC}"
pnpm exec lint-staged

if [ $? -ne 0 ]; then
  echo ""
  echo "${RED}🙅🏻‍♀️ lint-staged 검사 실패${NC}"
  echo "${YELLOW}   오류를 수정한 후 다시 커밋해주세요.${NC}"
  echo ""
  exit 1
fi

# TypeScript 타입 체크 (전체 프로젝트)
echo "${BLUE}🔍 TypeScript 타입 체크 중...${NC}"
pnpm exec tsc --noEmit --project tsconfig.json

if [ $? -ne 0 ]; then
  echo ""
  echo "${RED}🙅🏻‍♀️ TypeScript 타입 오류가 있습니다.${NC}"
  echo "${YELLOW}   타입 오류를 수정한 후 다시 커밋해주세요.${NC}"
  echo ""
  exit 1
fi

# staged 파일에서 변경된 패키지 찾기
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
  echo "${GREEN}✓ 검사를 통과했습니다.${NC}"
  exit 0
fi

# packages 디렉토리의 staged 파일에서 패키지명 추출
CHANGED_PACKAGES=$(echo "$STAGED_FILES" | grep -E '^packages/[^/]+' | sed 's|packages/\([^/]*\).*|@joka/\1|' | sort -u)

if [ -z "$CHANGED_PACKAGES" ]; then
  # packages 외부 파일만 변경된 경우 (설정 파일 등)
  echo "${BLUE}ℹ️  packages 외부 파일만 변경되었습니다. 테스트를 건너뜁니다.${NC}"
  echo "${GREEN}✓ 검사를 통과했습니다.${NC}"
  exit 0
fi

# 변경된 패키지만 테스트 실행
echo "${BLUE}🧪 변경된 패키지 테스트 실행 중...${NC}"
echo "${CYAN}   대상: $(echo $CHANGED_PACKAGES | tr '\n' ' ')${NC}"

# Turbo의 --filter 옵션으로 특정 패키지만 테스트
FILTERS=$(echo "$CHANGED_PACKAGES" | tr '\n' ',' | sed 's/,$//')
pnpm exec turbo run test --filter="$FILTERS"

if [ $? -eq 0 ]; then
  echo "${GREEN}✓ 모든 검사를 통과했습니다.${NC}"
fi